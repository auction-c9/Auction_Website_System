package com.example.auction_management.service.impl;

import com.cloudinary.Cloudinary;
import com.cloudinary.utils.ObjectUtils;
import com.example.auction_management.config.CloudinaryConfig;
import com.example.auction_management.dto.ProductDTO;
import com.example.auction_management.exception.ProductCreationException;
import com.example.auction_management.exception.ProductNotFoundException;
import com.example.auction_management.exception.UnauthorizedActionException;
import com.example.auction_management.model.*;
import com.example.auction_management.repository.*;
import com.example.auction_management.service.EmailService;
import com.example.auction_management.service.IProductService;
import com.example.auction_management.service.NotificationService;
import com.example.auction_management.validation.AuctionCreateGroup;
import jakarta.transaction.Transactional;
import jakarta.validation.ConstraintViolation;
import jakarta.validation.ConstraintViolationException;
import lombok.RequiredArgsConstructor;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Service;
import jakarta.validation.Validator;
import org.springframework.web.multipart.MultipartFile;

import java.io.IOException;
import java.text.Normalizer;
import java.util.*;
import java.util.regex.Pattern;
import java.util.stream.Collectors;

@Service
@RequiredArgsConstructor
public class ProductService implements IProductService {

    private static final Logger logger = LoggerFactory.getLogger(ProductService.class);

    private final ProductRepository productRepository;
    private final CategoryRepository categoryRepository;
    private final ImageRepository imageRepository;
    private final AuctionRepository auctionRepository;
    private final AccountRepository accountRepository;
    private final Validator validator;
    private final EmailService emailService;
    private final AuctionRegistrationRepository auctionRegistrationRepository;
    private final CustomerRepository customerRepository;
    private final NotificationRepository notificationRepository;
    private final TransactionRepository transactionRepository;
    private final FollowRepository followRepository;   // Th√™m v√†o
    private final NotificationService notificationService; // Th√™m v√†o

    private final Cloudinary cloudinary = CloudinaryConfig.getCloudinary();

    // ------------------------- CORE SERVICES ----------------------------

    @Override
    public List<Product> findAll() {
        return productRepository.findAllByIsDeletedFalse(); //
    }

    @Override
    public Optional<Product> findById(Integer id) {
        return productRepository.findByProductIdAndIsDeletedFalse(id);
    }

    @Override
    public Product save(Product product) {
        return productRepository.save(product);
    }

    @Override
    public void deleteById(Integer id) {
        Product product = getProductByIdAndCheckOwner(id);
        product.setIsDeleted(true);
        productRepository.save(product);
        List<Auction> auctions = auctionRepository.findAllByProduct(product);
        auctions.forEach(auction -> {
            auction.setIsDeleted(true);
            auctionRepository.save(auction);
        });
    }

    // ------------------------- PRODUCT MANAGEMENT ----------------------------

    private final List<String> bannedWords = Arrays.asList(
            "ch·ªëng ph√°", "khi√™u d√¢m", "b·∫°o l·ª±c", "ph·∫£n ƒë·ªông", "x√¢m ph·∫°m ch·ªß quy·ªÅn", "an ninh qu·ªëc gia"
    ).stream().map(this::normalizeText).toList();

    private static final Pattern DIACRITIC_PATTERN = Pattern.compile("\\p{M}");

    @Transactional
    @Override
    public Product createProduct(ProductDTO dto) {
        Account account = getAuthenticatedAccount();
        Category category = getCategory(dto.getCategoryId());

        Customer customer = customerRepository.findByAccount_AccountId(account.getAccountId())
                .orElseThrow(() -> new ProductCreationException("T√†i kho·∫£n kh√¥ng li√™n k·∫øt v·ªõi Customer"));
        if (containsBannedWords(dto.getName()) || containsBannedWords(dto.getDescription())) {
            System.out.println("Vi ph·∫°m t·ª´ c·∫•m: " + dto.getName() + " ho·∫∑c " + dto.getDescription());
            handleViolation(account);
            throw new ProductCreationException("N·ªôi dung s·∫£n ph·∫©m ch·ª©a t·ª´ ng·ªØ kh√¥ng h·ª£p l·ªá!");
        }

        try {
            Product product = buildProduct(dto, account, category);
            product = productRepository.save(product);
            uploadDetailImages(dto.getImageFiles(), product);
            Auction auction = createAuction(dto, product);

            if (auctionRegistrationRepository.existsByAuctionAndCustomer(auction, customer)) {
                throw new ProductCreationException("Customer ƒë√£ ƒëƒÉng k√Ω auction n√†y");
            }

            AuctionRegistration registration = new AuctionRegistration();
            registration.setAuction(auction);
            registration.setCustomer(customer);
            auctionRegistrationRepository.save(registration);

            notifyFollowers(product, auction);
            return product;
        } catch (IOException e) {
            logger.error("L·ªói khi t·∫°o s·∫£n ph·∫©m: {}", e.getMessage(), e);
            throw new ProductCreationException("L·ªói khi t·∫°o s·∫£n ph·∫©m: " + e.getMessage());
        }
    }

    /**
     * G·ª≠i th√¥ng b√°o cho nh·ªØng follower c·ªßa seller khi seller ƒëƒÉng b√†i (s·∫£n ph·∫©m) m·ªõi.
     * @param product S·∫£n ph·∫©m m·ªõi ƒë∆∞·ª£c t·∫°o
     * @param auction Phi√™n ƒë·∫•u gi√° li√™n quan ƒë·∫øn s·∫£n ph·∫©m
     */
    private void notifyFollowers(Product product, Auction auction) {
        // L·∫•y seller t·ª´ th√¥ng tin t√†i kho·∫£n c·ªßa s·∫£n ph·∫©m
        Customer seller = product.getAccount().getCustomer();

        // L·∫•y danh s√°ch follower c·ªßa seller
        List<Customer> followers = followRepository.findFollowersBySeller(seller);

        // N·ªôi dung th√¥ng b√°o, c√≥ th·ªÉ t√πy ch·ªânh th√™m th√¥ng tin
        String message = String.format("Seller %s v·ª´a ƒëƒÉng s·∫£n ph·∫©m m·ªõi: %s",
                seller.getName(), product.getName());

        // G·ª≠i th√¥ng b√°o cho t·ª´ng follower th√¥ng qua NotificationService
        for (Customer follower : followers) {
            notificationService.sendNotification(follower.getCustomerId(), message, auction);
        }
    }



    private boolean containsBannedWords(String text) {
        if (text == null || text.trim().isEmpty()) return false;
        String cleanedText = normalizeText(text);
        System.out.println("üîç N·ªôi dung g·ªëc: " + text);
        System.out.println("‚úÖ N·ªôi dung sau chu·∫©n h√≥a: " + cleanedText);
        boolean contains = bannedWords.stream().anyMatch(cleanedText::contains);
        System.out.println("‚ö†Ô∏è K·∫øt qu·∫£ ki·ªÉm tra: " + (contains ? "C√≥ ch·ª©a t·ª´ c·∫•m!" : "Kh√¥ng c√≥ t·ª´ c·∫•m."));

        return contains;
    }

    private String normalizeText(String input) {
        if (input == null) return "";
        String normalized = Normalizer.normalize(input, Normalizer.Form.NFD);
        normalized = DIACRITIC_PATTERN.matcher(normalized).replaceAll("");
        return normalized.replaceAll("[^\\p{L}\\p{N}\\s]", "").replaceAll("\\s+", " ").trim().toLowerCase();
    }

    @Transactional
    public void handleViolation(Account account) {
        int newCount = account.getViolationCount() + 1;
        account.setViolationCount(newCount);

        accountRepository.save(account);
        SecurityContextHolder.getContext().setAuthentication(null);

        Customer customer = account.getCustomer();
        String email = (customer != null) ? customer.getEmail() : null;

        if (email == null) {
            throw new RuntimeException("Kh√¥ng t√¨m th·∫•y email c·ªßa t√†i kho·∫£n");
        }

        if (newCount >= 3) {
            account.setLocked(true);
            account.setStatus(Account.AccountStatus.inactive);

            emailService.sendEmail(email, "Th√¥ng b√°o kh√≥a t√†i kho·∫£n",
                    "T√†i kho·∫£n c·ªßa b·∫°n ƒë√£ b·ªã kh√≥a do vi ph·∫°m n·ªôi dung qu√° nhi·ªÅu l·∫ßn.");
        } else {
            emailService.sendEmail(email, "C·∫£nh b√°o vi ph·∫°m n·ªôi dung",
                    "B·∫°n ƒë√£ vi ph·∫°m n·ªôi dung s·∫£n ph·∫©m. Vui l√≤ng ch·ªânh s·ª≠a ƒë·ªÉ tr√°nh b·ªã kh√≥a t√†i kho·∫£n.");
        }
    }

    @Override
    @Transactional
    public Page<Product> getAllProducts(Pageable pageable) {
        return productRepository.findAllWithDetails(pageable);
    }

    @Transactional
    @Override
    public void deleteProduct(Integer productId) {
        Product product = productRepository.findById(productId)
                .orElseThrow(() -> new RuntimeException("S·∫£n ph·∫©m kh√¥ng t·ªìn t·∫°i"));
        Account account = product.getAccount();
        if (account != null && account.getCustomer() != null) {
            String userEmail = account.getCustomer().getEmail();
            String userName = account.getCustomer().getName();
            String productName = product.getName();

            String subject = "Th√¥ng b√°o: S·∫£n ph·∫©m c·ªßa b·∫°n ƒë√£ b·ªã x√≥a";
            String emailContent = generateDeleteProductEmailContent(userName, productName);

            emailService.sendEmail(userEmail, subject, emailContent);
        }
        for (Auction auction : product.getAuctions()) {
            transactionRepository.deleteByAuction(auction);
        }
        for (Auction auction : product.getAuctions()) {
            notificationRepository.deleteByAuction(auction);
        }
        imageRepository.deleteByProduct(product);
        auctionRepository.deleteByProduct(product);
        productRepository.delete(product);
    }

    private String generateDeleteProductEmailContent(String customerName, String productName) {
        return "<!DOCTYPE html>" +
                "<html>" +
                "<head>" +
                "    <meta charset='UTF-8'>" +
                "    <style>" +
                "        body { font-family: Arial, sans-serif; line-height: 1.8; color: #333; margin: 0; padding: 0; font-size: 16px; }" +
                "        .content { padding: 25px; background-color: #f9f9f9; border-radius: 8px; max-width: 600px; margin: 20px auto; text-align: left; font-size: 18px; }" +
                "        .footer { margin-top: 20px; padding-top: 20px; border-top: 1px solid #ddd; font-size: 16px; color: #666; text-align: left; }" +
                "        .footer strong { color: #333; font-size: 17px; }" +
                "        .footer a { color: #007BFF; text-decoration: none; font-size: 16px; }" +
                "        .footer a:hover { text-decoration: underline; }" +
                "    </style>" +
                "</head>" +
                "<body>" +
                "<div class='content'>" +
                "    <p style='font-size: 20px;'><strong>Xin ch√†o, " + customerName + "!</strong></p>" +
                "    <p>Ch√∫ng t√¥i xin th√¥ng b√°o r·∫±ng s·∫£n ph·∫©m <strong>\"" + productName + "\"</strong> c·ªßa b·∫°n ƒë√£ b·ªã x√≥a kh·ªèi h·ªá th·ªëng do vi ph·∫°m ch√≠nh s√°ch ƒëƒÉng b√†i c·ªßa ch√∫ng t√¥i.</p>" +
                "    <p>N·∫øu b·∫°n c√≥ b·∫•t k·ª≥ th·∫Øc m·∫Øc n√†o, vui l√≤ng li√™n h·ªá v·ªõi ch√∫ng t√¥i ƒë·ªÉ ƒë∆∞·ª£c h·ªó tr·ª£.</p>" +
                "</div>" +
                "<div class='footer'>" +
                "    <p>Tr√¢n tr·ªçng,</p>" +
                "    <p><strong>C9-Stock</strong></p>" +
                "    <p>üìç ƒê·ªãa ch·ªâ: 295 Nguy·ªÖn T·∫•t Th√†nh, Thanh B√¨nh, H·∫£i Ch√¢u, ƒê√† N·∫µng</p>" +
                "    <p>üìû S·ªë ƒëi·ªán tho·∫°i: <a href='tel:+84356789999'>+84 356789999</a></p>" +
                "    <p>‚úâ Email: <a href='mailto:daugiavn123@gmail.com'>daugiavn123@gmail.com</a></p>" +
                "</div>" +
                "</body>" +
                "</html>";
    }

    @Transactional

    public Product updateProduct(Integer productId, ProductDTO dto) {
        Product product = getProductByIdAndCheckOwner(productId);
        try {
            updateProductData(dto, product);
            return productRepository.save(product);
        } catch (IOException e) {
            throw new ProductCreationException("L·ªói c·∫≠p nh·∫≠t s·∫£n ph·∫©m: " + e.getMessage());
        }
    }

    @Transactional

    public void endAuction(Integer productId) {
        Product product = getProductByIdAndCheckOwner(productId);
        Auction auction = auctionRepository.findByProduct(product)
                .orElseThrow(() -> new ProductNotFoundException("Kh√¥ng t√¨m th·∫•y phi√™n ƒë·∫•u gi√° c·ªßa s·∫£n ph·∫©m n√†y"));
        auction.setStatus(Auction.AuctionStatus.ended);
        auctionRepository.save(auction);
    }

    @Transactional

    public void confirmWinner(Integer productId, Integer accountId) {
        Product product = getProductByIdAndCheckOwner(productId);
        Auction auction = auctionRepository.findByProduct(product)
                .orElseThrow(() -> new ProductNotFoundException("Kh√¥ng t√¨m th·∫•y phi√™n ƒë·∫•u gi√° c·ªßa s·∫£n ph·∫©m n√†y"));

        boolean isWinnerValid = auction.getBids().stream()
                .anyMatch(bid -> bid.getAccount().getAccountId().equals(accountId));
        if (!isWinnerValid) throw new ProductCreationException("T√†i kho·∫£n kh√¥ng h·ª£p l·ªá ƒë·ªÉ tr·ªü th√†nh ng∆∞·ªùi chi·∫øn th·∫Øng");

        auction.getBids().forEach(bid -> bid.setIsWinner(bid.getAccount().getAccountId().equals(accountId)));
    }

    // ------------------------- EXTENDED METHODS ----------------------------


    public List<Product> findMyProducts() {
        String username = SecurityContextHolder.getContext().getAuthentication().getName();
        return productRepository.findByAccountUsername(username).stream()
                .filter(product -> !Boolean.TRUE.equals(product.getIsDeleted()))
                .collect(Collectors.toList());
    }


    public List<Bid> getAuctionHistory(Integer productId) {
        Product product = productRepository.findById(productId)
                .orElseThrow(() -> new ProductNotFoundException("Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m v·ªõi ID: " + productId));
        Auction auction = auctionRepository.findByProduct(product)
                .orElseThrow(() -> new ProductNotFoundException("Kh√¥ng t√¨m th·∫•y phi√™n ƒë·∫•u gi√° c·ªßa s·∫£n ph·∫©m"));
        return auction.getBids();
    }

    // ------------------------- PRIVATE SUPPORT METHODS ----------------------------

    private Account getAuthenticatedAccount() {
        String username = SecurityContextHolder.getContext().getAuthentication().getName();
        return accountRepository.findByUsername(username)
                .orElseThrow(() -> new ProductCreationException("Kh√¥ng t√¨m th·∫•y t√†i kho·∫£n: " + username));
    }

    private Category getCategory(Integer categoryId) {
        return categoryRepository.findById(categoryId)
                .orElseThrow(() -> new ProductCreationException("Kh√¥ng t√¨m th·∫•y danh m·ª•c: " + categoryId));
    }

    private Product buildProduct(ProductDTO dto, Account account, Category category) {
        return Product.builder()
                .name(dto.getName())
                .category(category)
                .description(dto.getDescription())
                .basePrice(dto.getBasePrice())
                .isDeleted(false)
                .account(account)
                // Kh√¥ng g√°n ·∫£nh ƒë·∫°i di·ªán ·ªü ƒë√¢y, v√¨ vi·ªác upload ·∫£nh s·∫Ω ƒë∆∞·ª£c th·ª±c hi·ªán qua imageFiles
                .images(new ArrayList<>())
                .build();
    }

    private void uploadDetailImages(List<MultipartFile> imageFiles, Product product) throws IOException {
        for (MultipartFile file : imageFiles) {
            if (!file.isEmpty()) {
                String imageUrl = uploadFile(file);
                Image image = new Image();
                image.setImageUrl(imageUrl);
                image.setProduct(product);
                imageRepository.save(image);
                product.getImages().add(image);
            }
        }
    }

    private Auction createAuction(ProductDTO dto, Product product) {
        Auction auction = Auction.builder()
                .product(product)
                .auctionStartTime(dto.getAuctionStartTime())
                .auctionEndTime(dto.getAuctionEndTime())
                .bidStep(dto.getBidStep())
                .currentPrice(dto.getBasePrice())
                .status(Auction.AuctionStatus.valueOf(dto.getStatus()))
                .isDeleted(false)
                .winnerNotified(false) // Th√™m d√≤ng n√†y ƒë·ªÉ ƒë·∫£m b·∫£o tr∆∞·ªùng kh√¥ng null
                .build();

        // Validate theo nh√≥m AuctionCreateGroup
        Set<ConstraintViolation<Auction>> violations = validator.validate(auction, AuctionCreateGroup.class);
        if (!violations.isEmpty()) {
            // N·∫øu c√≥ l·ªói, n√©m ra exception ho·∫∑c x·ª≠ l√Ω theo c√°ch b·∫°n mu·ªën
            throw new ConstraintViolationException(violations);
        }

        auctionRepository.save(auction);
        return auctionRepository.save(auction);
    }

    private String uploadFile(MultipartFile file) throws IOException {
        Map<?, ?> uploadResult = cloudinary.uploader().upload(file.getBytes(), ObjectUtils.emptyMap());
        return uploadResult.get("secure_url").toString();
    }

    private Product getProductByIdAndCheckOwner(Integer productId) {
        Product product = productRepository.findById(productId)
                .orElseThrow(() -> new ProductNotFoundException("Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m: " + productId));
        String username = SecurityContextHolder.getContext().getAuthentication().getName();
        if (!product.getAccount().getUsername().equals(username)) {
            throw new UnauthorizedActionException("Kh√¥ng c√≥ quy·ªÅn tr√™n s·∫£n ph·∫©m n√†y");
        }
        return product;
    }

    private void updateProductData(ProductDTO dto, Product product) throws IOException {
        product.setName(dto.getName());
        product.setDescription(dto.getDescription());
        product.setBasePrice(dto.getBasePrice());
        product.setCategory(getCategory(dto.getCategoryId()));
        // N·∫øu mu·ªën c·∫≠p nh·∫≠t ·∫£nh s·∫£n ph·∫©m th√¨ c√≥ th·ªÉ xo√° ·∫£nh c≈© v√† upload danh s√°ch ·∫£nh m·ªõi
        // V√≠ d·ª•:
        // product.getImages().clear();
        // uploadDetailImages(dto.getImageFiles(), product);
        uploadDetailImages(dto.getImageFiles(), product);
    }
}